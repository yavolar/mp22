<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MP22</title>

  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png"> 
  <meta name="theme-color" content="#000000" />

  <style>
    :root{
      --bg:#000000;
      --btn:#40E0D0;
      --txt:#000000;
      --hint:#aaaaaa;
    }
    html, body { height:100%; margin:0; }
    body{
      background:var(--bg);
      display:flex;
      align-items:center;
      justify-content:center;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{ text-align:center; }
    .btn{
      width:220px; height:220px;
      border-radius:50%;
      border:none;
      background:var(--btn);
      cursor:pointer;
      box-shadow:0 0 0 6px rgba(64,224,208,0.18);
      -webkit-tap-highlight-color:transparent;
      transition:transform .05s ease, filter .05s ease;
    }
    .btn:active{ transform:scale(0.96); filter:brightness(0.95); }
    .label{
      color:var(--txt);
      font-weight:700;
      font-size:30px;
      letter-spacing:.06em;
      user-select:none;
    }
    .hint{
      margin-top:14px;
      font-size:13px;
      color:var(--hint);
      user-select:none;
      min-height:1.2em;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <button class="btn" id="btn" aria-label="MP22"><span class="label">MP22</span></button>
    <div class="hint" id="hint">Listo</div>
  </div>

  <script>
    /* ================= CONFIG ================= */
    const WORKER_BASE = "https://restless-surf-375f.ltudela.workers.dev/pulse";
    const TOKEN_KEY   = "MP22_TOKEN";
    const MIN_LEN     = 30;     // ignora ?t= cortos (bug típico en PWA Android)
    const VIBRATE_MS  = [80, 40, 80]; // patrón de vibración al OK
    /* ========================================= */

    const btn  = document.getElementById("btn");
    const hint = document.getElementById("hint");

    function setHint(t){ hint.textContent = t; }

    function getQsToken(){
      const raw = new URLSearchParams(location.search).get("t");
      return (raw && raw.length >= MIN_LEN) ? raw : null;
    }
    function getSavedToken(){
      try { return localStorage.getItem(TOKEN_KEY); } catch { return null; }
    }
    function setSavedToken(tok){
      try { localStorage.setItem(TOKEN_KEY, tok); return true; } catch { return false; }
    }

    // Captura token válido desde la URL y lo persiste
    const qsToken = getQsToken();
    if (qsToken) setSavedToken(qsToken);

    function effectiveToken(){
      return getQsToken() || getSavedToken();
    }

    btn.addEventListener("click", async () => {
      const token = effectiveToken();
      if (!token) { setHint("Falta token"); return; }

      btn.disabled = true;
      setHint("Enviando…");

      try {
        const url = `${WORKER_BASE}?token=${encodeURIComponent(token)}&ts=${Date.now()}`;
        const r = await fetch(url, { method: "GET", cache: "no-store" });
        if (!r.ok) throw new Error("HTTP " + r.status);

        // Vibración (si el dispositivo lo permite)
        if (navigator.vibrate) navigator.vibrate(VIBRATE_MS);

        setHint("OK");
      } catch (e) {
        setHint(e?.message || String(e));
      } finally {
        setTimeout(() => setHint("Listo"), 1200);
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
