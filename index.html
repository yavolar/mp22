<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MP22</title>

  <link rel="manifest" href="./manifest.json">

  <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png">

  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">

  <style>
    :root{
      --bg:#000000;
      --btn:#40E0D0;
      --txt:#000000;
      --hint:#aaaaaa;
    }

    html, body {
      height: 100%;
      margin: 0;
    }

    body {
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .btn {
      width: clamp(200px, 30vw, 240px);
      height: clamp(200px, 30vw, 240px);
      border-radius: 50%;
      border: none;
      background: var(--btn);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 0 0 6px rgba(64,224,208,0.18);
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.05s ease, filter 0.05s ease;
    }

    .btn:active {
      transform: scale(0.96);
      filter: brightness(0.95);
    }

    .label {
      color: var(--txt);
      font-weight: 600;
      font-size: 30px;
      letter-spacing: 0.06em;
      user-select: none;
    }

    .hint {
      position: fixed;
      bottom: 18px;
      width: 100%;
      text-align: center;
      font-size: 13px;
      color: var(--hint);
      user-select: none;
    }
  </style>
</head>

<body>

  <button class="btn" id="btn" aria-label="MP22">
    <span class="label">MP22</span>
  </button>

  <div class="hint" id="hint">Listo</div>

  <script>
    /* ================= CONFIG ================= */

    // URL del Cloudflare Worker (la que funciona en tu caso)
    const WORKER_URL = "https://restless-surf-375f.ltudela.workers.dev/pulse";

    // Clave de almacenamiento local del token
    const TOKEN_KEY = "MP22_TOKEN";

    /* ========================================= */

    const btn  = document.getElementById("btn");
    const hint = document.getElementById("hint");

    function setHint(txt){
      hint.textContent = txt;
    }

    // ---- Token: URL (?t=...) o persistido en localStorage ----
    const qsToken = new URLSearchParams(location.search).get("t");
    const savedToken = localStorage.getItem(TOKEN_KEY);
    let token = qsToken || savedToken;

    // Si viene por URL, lo guardamos para que la PWA funcione sin querystring
    if (qsToken) {
      localStorage.setItem(TOKEN_KEY, qsToken);
      token = qsToken;
    }

    // Indicador inicial (opcional)
    if (!token) setHint("Falta token");

    // ---- Reset token (mantener pulsado 2s sobre el texto "Listo") ----
    let pressTimer = null;
    hint.addEventListener("pointerdown", () => {
      pressTimer = setTimeout(() => {
        localStorage.removeItem(TOKEN_KEY);
        token = null;
        setHint("Token borrado");
        setTimeout(() => setHint("Falta token"), 1200);
      }, 2000);
    });
    hint.addEventListener("pointerup", () => { if (pressTimer) clearTimeout(pressTimer); });
    hint.addEventListener("pointerleave", () => { if (pressTimer) clearTimeout(pressTimer); });

    btn.addEventListener("click", async () => {

      // Releer por si se ha guardado/borrado
      const qs = new URLSearchParams(location.search).get("t");
      const sv = localStorage.getItem(TOKEN_KEY);
      token = qs || sv;

      if (qs) {
        localStorage.setItem(TOKEN_KEY, qs);
        token = qs;
      }

      if (!token) {
        setHint("Falta token");
        return;
      }

      btn.disabled = true;
      setHint("Enviando…");

      try {
        const r = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          cache: "no-store",
          body: JSON.stringify({ token: token, cmd: "PULSE" })
        });

        if (!r.ok) throw new Error("HTTP " + r.status);

        setHint("OK");
      } catch (e) {
        // Muestra el error real (más útil que "Error")
        setHint(e?.message || String(e));
      } finally {
        setTimeout(() => {
          // Si hay token guardado, volvemos a “Listo”. Si no, “Falta token”.
          const still = localStorage.getItem(TOKEN_KEY);
          setHint(still ? "Listo" : "Falta token");
        }, 1200);

        btn.disabled = false;
      }
    });
  </script>

</body>
</html>
